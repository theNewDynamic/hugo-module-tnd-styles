{{/*
  GetStyleAssets
  Groups all the necessary resources by critical or link.

  @author @regisphilibert

  @context Any (.)

  @access private

  @return Slice of Maps
    Resource (.style=link|critical)
    String (.type)

*/}}
{{ $style_assets := slice }}
{{ $return := slice }}

{{ $to_bundle := slice }}
{{/* We look for a style.* file */}}
{{ with resources.GetMatch "css/style.*" }}
  {{ $style := false }}
  {{/* If the resource type is scss or sass, we use the sass logic
    we will generate a tailwind file, concatenate it with the processed sass and PostCSS it. */}}
  {{ if eq .MediaType.SubType "x-scss" "sass" }}
    {{ $scss := . | toCSS }}
    {{ $tailwind := `

    /* purgecss start ignore */
    @import "tailwindcss/base";
    
    @import "tailwindcss/components";
    
    /* purgecss end ignore */
    
    @import "tailwindcss/utilities";
    ` }}
    {{ $tailwind := $tailwind | resources.FromString "tailwind.css" }}
    {{ $style = resources.Concat "style.css" (slice $tailwind $scss) | resources.PostCSS }}
  {{ else }}
    {{/* If file is not scss, we simply PostCSS it. */}}
    {{ $style = . | resources.PostCSS }}
  {{ end }}
  
  {{ $style_assets = $style_assets | append (dict "style" $style "type" "link") }}
{{ end }}

{{/* We retrieve the set fonts */}}
{{ with partialCached "tnd-styles/private/GetFonts" "GetFonts" }}
  {{/* And generte the @fontface css declaration from a template */}}
  {{ $fontface := resources.Get "tnd-styles/fonts.css" | resources.ExecuteAsTemplate "fonts.css" "no_context" }}
  {{ $style_assets = $style_assets | append (dict "style" $fontface "type" "critical") }}
{{ end }}

{{/* If not server and not critical, we apply more transformations before filling the returned slice */}}
{{ range $style_assets }}
  {{ $style := . }}
  {{ if and (eq (getenv "HUGO_ENV") "production") (not site.IsServer) (ne .type "critical") }}
    {{ $style = dict "type" .type "style" (.style | minify | fingerprint | resources.PostProcess) }}
  {{ end }}
  {{ $return = $return | append $style }}
{{ end }}

{{ return $return }}